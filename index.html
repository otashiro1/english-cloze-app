<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéì British Summer School Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Outfit:wght@400;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* ===== Design Tokens ===== */
    :root {
      --navy: #1b2a4a;
      --navy-light: #263b65;
      --gold: #d4a843;
      --gold-bright: #f0c75e;
      --cream: #faf6ed;
      --red: #b5303f;
      --green: #1ea362;
      --green-light: #d0f5e0;
      --red-light: #fde2e4;
      --panel: #ffffff;
      --muted: #7a8599;
      --text: #1b2a4a;
      --ring: #d6dbe6;
      --shadow: rgba(27, 42, 74, .12);
    }

    /* ===== Reset & Base ===== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: 'Outfit', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, #1b2a4a 0%, #263b65 40%, #1b2a4a 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Subtle Union Jack diagonal stripes */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        linear-gradient(30deg, transparent 48.5%, rgba(181, 48, 63, .06) 48.5%, rgba(181, 48, 63, .06) 51.5%, transparent 51.5%),
        linear-gradient(-30deg, transparent 48.5%, rgba(181, 48, 63, .06) 48.5%, rgba(181, 48, 63, .06) 51.5%, transparent 51.5%),
        linear-gradient(0deg, transparent 48%, rgba(255, 255, 255, .03) 48%, rgba(255, 255, 255, .03) 52%, transparent 52%),
        linear-gradient(90deg, transparent 48%, rgba(255, 255, 255, .03) 48%, rgba(255, 255, 255, .03) 52%, transparent 52%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* ===== Header ===== */
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 28px 20px 18px;
      background: linear-gradient(135deg, var(--navy-light), var(--navy));
      border-radius: 24px;
      border: 2px solid var(--gold);
      box-shadow: 0 8px 32px rgba(0, 0, 0, .3), inset 0 1px 0 rgba(255, 255, 255, .08);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 30% 30%, rgba(212, 168, 67, .08) 0%, transparent 60%);
      pointer-events: none;
    }

    h1 {
      font-family: 'Fredoka', 'Outfit', sans-serif;
      font-size: clamp(26px, 5vw, 40px);
      font-weight: 700;
      margin: 0 0 4px;
      color: var(--gold-bright);
      text-shadow: 0 2px 8px rgba(0, 0, 0, .3);
      letter-spacing: 0.5px;
    }

    .subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, .6);
      margin-bottom: 10px;
    }

    #stats {
      display: inline-block;
      color: #fff;
      font-size: 14px;
      background: rgba(255, 255, 255, .1);
      padding: 6px 18px;
      border-radius: 20px;
      backdrop-filter: blur(4px);
    }

    .streak-display {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #ff6b35, #ff4500);
      color: #fff;
      font-family: 'Fredoka', sans-serif;
      font-weight: 700;
      font-size: 16px;
      padding: 6px 16px;
      border-radius: 20px;
      margin-left: 8px;
      box-shadow: 0 2px 12px rgba(255, 69, 0, .3);
      transition: transform .2s, box-shadow .2s;
    }

    .streak-display.mega {
      background: linear-gradient(135deg, #ff4500, #ff0080, #ff4500);
      background-size: 200% 200%;
      animation: megaStreak 1s ease infinite;
      box-shadow: 0 2px 20px rgba(255, 0, 128, .4);
      transform: scale(1.1);
    }

    @keyframes megaStreak {

      0%,
      100% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }
    }

    /* ===== Toolbar ===== */
    .toolbar-card {
      background: var(--panel);
      border-radius: 18px;
      padding: 14px 18px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px var(--shadow);
      border: 1px solid var(--ring);
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar label {
      font-weight: 600;
      font-size: 14px;
      color: var(--navy);
    }

    select {
      border: 2px solid var(--ring);
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 15px;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      background: #fff;
      color: var(--navy);
      cursor: pointer;
      transition: border-color .2s;
    }

    select:focus {
      outline: none;
      border-color: var(--gold);
    }

    .toolbar-note {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
    }

    /* ===== Buttons ===== */
    button {
      border: 2px solid var(--ring);
      background: #fff;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 14px;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, .1);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--navy), var(--navy-light));
      color: var(--gold-bright);
      border-color: var(--gold);
      font-size: 15px;
      padding: 10px 22px;
      letter-spacing: .5px;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--navy-light), #2f4d80);
      box-shadow: 0 6px 20px rgba(212, 168, 67, .3);
    }

    .btn-danger {
      border-color: #fca5a5;
      background: #fff5f5;
      color: var(--red);
    }

    .btn-danger:hover {
      background: #fee;
    }

    /* ===== Question List ===== */
    .list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .item {
      background: var(--panel);
      border: 2px solid var(--ring);
      border-radius: 20px;
      padding: 18px 20px;
      box-shadow: 0 4px 16px var(--shadow);
      transition: all .3s ease;
      position: relative;
      overflow: hidden;
    }

    .item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: linear-gradient(180deg, var(--gold), var(--gold-bright));
      border-radius: 20px 0 0 20px;
    }

    .item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 28px var(--shadow);
    }

    .item-head {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .idx {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--navy), var(--navy-light));
      color: var(--gold-bright);
      font-family: 'Fredoka', sans-serif;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }

    .cloze {
      font-size: clamp(18px, 2.6vw, 24px);
      font-weight: 600;
      background: linear-gradient(135deg, #f8f6f0, #f0ece0);
      border-radius: 14px;
      padding: 14px 16px;
      line-height: 1.6;
      border: 1px solid #e8e0d0;
      color: var(--navy);
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      font-style: italic;
    }

    /* ===== Controls ===== */
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    input[type="text"] {
      border: 2px solid var(--ring);
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 17px;
      font-family: 'Outfit', sans-serif;
      min-width: 240px;
      flex: 1 1 240px;
      transition: border-color .2s, box-shadow .2s;
      color: var(--navy);
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 4px rgba(212, 168, 67, .15);
    }

    input[type="text"]::placeholder {
      color: #b0b8c8;
    }

    /* ===== Judge ===== */
    .judge {
      min-height: 24px;
      font-size: 15px;
      font-weight: 700;
      margin-top: 6px;
      font-family: 'Fredoka', sans-serif;
      transition: all .3s;
    }

    .ok {
      color: var(--green);
      animation: judgePopIn .4s cubic-bezier(.175, .885, .32, 1.275);
    }

    .bad {
      color: var(--red);
    }

    @keyframes judgePopIn {
      0% {
        opacity: 0;
        transform: scale(.5) translateY(10px);
      }

      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ===== Correct State ===== */
    .item.correct-flash {
      border-color: var(--green);
      background: linear-gradient(135deg, #f0fff6, #e6faf0);
      animation: correctPulse .6s ease;
    }

    .item.correct-flash::before {
      background: linear-gradient(180deg, var(--green), #34d399);
    }

    @keyframes correctPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(30, 163, 98, .4);
      }

      50% {
        box-shadow: 0 0 0 12px rgba(30, 163, 98, 0);
      }

      100% {
        box-shadow: 0 4px 16px var(--shadow);
      }
    }

    /* ===== Wrong Shake ===== */
    .item.wrong-shake {
      animation: shake .5s ease;
      border-color: var(--red);
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      15% {
        transform: translateX(-8px);
      }

      30% {
        transform: translateX(8px);
      }

      45% {
        transform: translateX(-6px);
      }

      60% {
        transform: translateX(6px);
      }

      75% {
        transform: translateX(-3px);
      }

      90% {
        transform: translateX(3px);
      }
    }

    /* ===== Celebration Overlay ===== */
    .celebration-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-family: 'Fredoka', sans-serif;
      font-size: clamp(48px, 10vw, 90px);
      font-weight: 700;
      color: var(--gold-bright);
      text-shadow:
        0 0 20px rgba(240, 199, 94, .6),
        0 4px 12px rgba(0, 0, 0, .4),
        0 0 60px rgba(240, 199, 94, .3);
      z-index: 9999;
      pointer-events: none;
      white-space: nowrap;
      animation: celebZoom 1.8s cubic-bezier(.175, .885, .32, 1.275) forwards;
    }

    @keyframes celebZoom {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-10deg);
        opacity: 0;
      }

      20% {
        transform: translate(-50%, -50%) scale(1.2) rotate(3deg);
        opacity: 1;
      }

      35% {
        transform: translate(-50%, -50%) scale(1) rotate(0);
        opacity: 1;
      }

      75% {
        transform: translate(-50%, -50%) scale(1) rotate(0);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) scale(1.5) rotate(5deg);
        opacity: 0;
      }
    }

    /* ===== Mega Celebration (5-streak) ===== */
    .mega-celebration-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-family: 'Fredoka', sans-serif;
      font-size: clamp(36px, 8vw, 72px);
      font-weight: 700;
      text-align: center;
      background: linear-gradient(90deg, #ff0080, #ff8c00, #40e0d0, #ff0080);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, .3));
      z-index: 9999;
      pointer-events: none;
      animation: megaCelebZoom 2.5s cubic-bezier(.175, .885, .32, 1.275) forwards,
        rainbowShift 1s linear infinite;
    }

    @keyframes megaCelebZoom {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-15deg);
        opacity: 0;
      }

      15% {
        transform: translate(-50%, -50%) scale(1.3) rotate(5deg);
        opacity: 1;
      }

      30% {
        transform: translate(-50%, -50%) scale(1) rotate(0);
        opacity: 1;
      }

      80% {
        transform: translate(-50%, -50%) scale(1) rotate(0);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) scale(2) rotate(10deg);
        opacity: 0;
      }
    }

    @keyframes rainbowShift {
      0% {
        background-position: 0% 50%
      }

      100% {
        background-position: 100% 50%
      }
    }

    /* ===== Confetti Canvas ===== */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9998;
    }

    /* ===== Footer ===== */
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
      color: rgba(255, 255, 255, .4);
      padding-bottom: 16px;
    }

    .footer code {
      background: rgba(255, 255, 255, .1);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* ===== Responsive ===== */
    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }

      header {
        padding: 20px 14px 14px;
      }

      .item {
        padding: 14px 14px 14px 18px;
      }

      .controls {
        flex-direction: column;
      }

      input[type="text"] {
        min-width: 100%;
        flex: 1 1 100%;
      }

      .streak-display {
        margin-left: 0;
        margin-top: 6px;
      }
    }
  </style>
</head>

<body>
  <canvas id="confetti-canvas"></canvas>

  <div class="container">
    <header>
      <h1>üéì British Summer School Quiz</h1>
      <div class="subtitle">‚Äî English Vocabulary Challenge ‚Äî</div>
      <div>
        <span id="stats">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</span>
        <span id="streak-badge" class="streak-display" style="display:none;">üî• <span id="streak-count">0</span></span>
      </div>
    </header>

    <div class="toolbar-card">
      <div class="toolbar">
        <label for="collection">üìö Book</label>
        <select id="collection"></select>
        <label for="lesson">üìù Lesson</label>
        <select id="lesson"></select>
        <button id="btn-hint" title="Êó•Êú¨Ë™û„Éí„É≥„Éà„ÅÆON/OFF">üí° Hint OFF</button>
        <button id="btn-reset" class="btn-danger" title="„Åì„ÅÆ„É¨„ÉÉ„Çπ„É≥„ÅÆÊàêÁ∏æ„Çí„É™„Çª„ÉÉ„Éà">üóë Reset</button>
      </div>
      <div class="toolbar-note">‚Äª Ë§áÊï∞Ë™û„ÅÆËß£Á≠î„ÅØ„ÄÅË™ûÊï∞„Å∂„Çì <strong>____</strong> „Åå‰∏¶„Å≥„Åæ„ÅôÔºà‰æãÔºö<em>in a flash</em> ‚Üí <strong>____ ____
          ____</strong>Ôºâ„ÄÇÂÖ•ÂäõÊ¨Ñ„ÅØË™ûÂè•ÂÖ®‰Ωì„ÇíÂçäËßí„Çπ„Éö„Éº„Çπ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
    </div>

    <div id="list" class="list"></div>

    <div class="footer">„Éá„Éº„ÇøÁ∑®ÈõÜ„ÅØHTMLÊú´Â∞æ„ÅÆ <code>LESSONS</code> „ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇUTF-8„Åß‰øùÂ≠ò„Åó„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åë„Å∞Âãï„Åç„Åæ„Åô„ÄÇ</div>
  </div>

  <script src="data.js"></script>
  <script>
    // ===== Data (Lesson 1‚Äì6) =====
    // ===== Data (Loaded from data.js) =====
    // const LESSONS = window.WORD_DATA["British Summer School"]; // Initial default

    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const LS_KEY_LESSON = 'cloze-app-lesson-stats-v2';
    const LS_KEY_ITEMS = 'cloze-app-item-attempts-v2';
    function normalize(s) { return s.toLowerCase().replace(/\s+/g, ' ').trim(); }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function todayISO() { const d = new Date(); const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000); return tz.toISOString().slice(0, 10); }
    function countWords(phrase) { return normalize(phrase).split(' ').length; }
    function blanksFor(phrase) { return Array.from({ length: countWords(phrase) }, () => '____').join(' '); }

    function buildAcceptableAnswers(base) {
      const b = normalize(base);
      if (b.includes(' ')) {
        const parts = b.split(' ');
        const last = parts[parts.length - 1];
        const set = new Set([b]);
        const sForm = last.endsWith('s') ? last : last + 's';
        set.add([...parts.slice(0, -1), sForm].join(' '));
        return [...set];
      }
      const set = new Set([b]);
      // stem: drop trailing 'e' for -ing/-ed (include‚Üíinclud, nudge‚Üínudg)
      const stem = b.endsWith('e') ? b.slice(0, -1) : b;
      if (!b.endsWith('s')) set.add(b + 's');
      if (!b.endsWith('es')) set.add(b + 'es');
      if (!b.endsWith('ed')) { set.add(b + 'ed'); set.add(stem + 'ed'); }
      if (!b.endsWith('ing')) { set.add(b + 'ing'); set.add(stem + 'ing'); }
      return [...set];
    }

    function makeCloze(sentence, base) {
      const variants = buildAcceptableAnswers(base).sort((a, b) => b.length - a.length);
      const multi = countWords(base) > 1;
      const replacement = multi ? blanksFor(base) : '____';
      let out = sentence, replaced = false;

      // 1st try: match the term (or its variants) as a contiguous phrase
      for (const v of variants) {
        const re = new RegExp(`\\b${escapeRegExp(v)}\\b`, 'i');
        if (re.test(out)) { out = out.replace(re, replacement); replaced = true; break; }
      }

      // 2nd try (multi-word only): blank each word of the base term individually,
      // in the order they appear in the sentence (handles "take better care of",
      // "signed us all up" etc.). Each word is also tried with all its inflections.
      if (!replaced && multi) {
        const termWords = normalize(base).split(' ');
        let result = out;
        let allFound = true;
        for (const w of termWords) {
          const wordVariants = buildAcceptableAnswers(w).sort((a, b) => b.length - a.length);
          let wordReplaced = false;
          for (const wv of wordVariants) {
            const re = new RegExp(`\\b${escapeRegExp(wv)}\\b`, 'i');
            if (re.test(result)) {
              result = result.replace(re, '____');
              wordReplaced = true;
              break;
            }
          }
          if (!wordReplaced) { allFound = false; break; }
        }
        if (allFound) { out = result; replaced = true; }
      }

      if (!replaced) out = `${sentence} (${replacement})`;
      return { text: out, replaced };
    }

    function load(key, fallback) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch { return fallback; } }
    function save(key, obj) { localStorage.setItem(key, JSON.stringify(obj)); }

    // ===== Fanfare (Web Audio API) =====
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function playFanfare(isMega) {
      const ctx = getAudioCtx();
      const now = ctx.currentTime;
      const masterGain = ctx.createGain();
      masterGain.gain.value = 0.18;
      masterGain.connect(ctx.destination);

      function playNote(freq, start, dur, type = 'square') {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        g.gain.setValueAtTime(0, now + start);
        g.gain.linearRampToValueAtTime(1, now + start + 0.03);
        g.gain.setValueAtTime(1, now + start + dur - 0.05);
        g.gain.linearRampToValueAtTime(0, now + start + dur);
        osc.connect(g);
        g.connect(masterGain);
        osc.start(now + start);
        osc.stop(now + start + dur);
      }

      if (isMega) {
        // Grand fanfare for 5-streak
        const notes = [523, 659, 784, 1047, 784, 1047, 1319];
        const times = [0, 0.12, 0.24, 0.36, 0.50, 0.65, 0.80];
        const durs = [0.15, 0.15, 0.15, 0.18, 0.18, 0.18, 0.5];
        notes.forEach((f, i) => {
          playNote(f, times[i], durs[i], 'square');
          playNote(f * 1.5, times[i], durs[i] * 0.8, 'triangle');
        });
        // Final chord
        [1047, 1319, 1568].forEach(f => {
          playNote(f, 1.0, 0.7, 'square');
          playNote(f * 0.5, 1.0, 0.7, 'triangle');
        });
      } else {
        // Short cheerful fanfare
        const notes = [523, 659, 784, 1047];
        const times = [0, 0.1, 0.2, 0.3];
        const durs = [0.12, 0.12, 0.12, 0.35];
        notes.forEach((f, i) => {
          playNote(f, times[i], durs[i], 'square');
          playNote(f * 1.5, times[i], durs[i] * 0.7, 'triangle');
        });
      }
    }

    function playWrongSound() {
      const ctx = getAudioCtx();
      const now = ctx.currentTime;
      const masterGain = ctx.createGain();
      masterGain.gain.value = 0.1;
      masterGain.connect(ctx.destination);
      // Gentle "womp womp"
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(350, now);
      osc.frequency.linearRampToValueAtTime(250, now + 0.3);
      g.gain.setValueAtTime(0.8, now);
      g.gain.linearRampToValueAtTime(0, now + 0.35);
      osc.connect(g);
      g.connect(masterGain);
      osc.start(now);
      osc.stop(now + 0.4);
    }

    // ===== Confetti =====
    const confettiCanvas = document.getElementById('confetti-canvas');
    const confettiCtx = confettiCanvas.getContext('2d');
    let confettiPieces = [];
    let confettiRAF = null;

    function resizeConfettiCanvas() {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeConfettiCanvas);
    resizeConfettiCanvas();

    const CONFETTI_COLORS = ['#f0c75e', '#b5303f', '#1b2a4a', '#1ea362', '#ff6b35', '#e91e8c', '#00bcd4', '#fff'];
    const CONFETTI_COLORS_MEGA = ['#ff0080', '#ff8c00', '#40e0d0', '#ff4081', '#7c4dff', '#ffeb3b', '#00e676', '#e040fb', '#fff'];

    function launchConfetti(isMega) {
      const count = isMega ? 200 : 80;
      const colors = isMega ? CONFETTI_COLORS_MEGA : CONFETTI_COLORS;
      confettiPieces = [];
      for (let i = 0; i < count; i++) {
        confettiPieces.push({
          x: Math.random() * confettiCanvas.width,
          y: -20 - Math.random() * confettiCanvas.height * 0.5,
          w: 6 + Math.random() * 8,
          h: 4 + Math.random() * 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          vx: (Math.random() - 0.5) * 6,
          vy: 2 + Math.random() * 4,
          rot: Math.random() * Math.PI * 2,
          rotSpeed: (Math.random() - 0.5) * 0.2,
          gravity: 0.06 + Math.random() * 0.04,
          opacity: 1
        });
      }
      if (confettiRAF) cancelAnimationFrame(confettiRAF);
      animateConfetti();
    }

    function animateConfetti() {
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      let alive = false;
      for (const p of confettiPieces) {
        if (p.opacity <= 0) continue;
        alive = true;
        p.vy += p.gravity;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.rotSpeed;
        if (p.y > confettiCanvas.height + 20) { p.opacity = 0; continue; }
        if (p.y > confettiCanvas.height * 0.7) p.opacity -= 0.02;
        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.rot);
        confettiCtx.globalAlpha = Math.max(0, p.opacity);
        confettiCtx.fillStyle = p.color;
        confettiCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        confettiCtx.restore();
      }
      if (alive) confettiRAF = requestAnimationFrame(animateConfetti);
      else confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    }

    // ===== Celebration Text =====
    const CHEERS = ['üéâ Brilliant!', '‚≠ê Splendid!', 'üèÜ Well Done!', 'üëè Bravo!', 'üåü Fantastic!', '‚ú® Superb!', 'üéä Top Marks!'];
    const CHEERS_MEGA = ['üèÜüî• OUTSTANDING! üî•üèÜ', 'üëë CHAMPION! üëë', 'üåà UNSTOPPABLE! üåà', '‚ö° LEGENDARY! ‚ö°'];
    const MISS_MSGS = ['Keep trying, old chap! üé©', 'Almost there! üí™', 'Have another go! üá¨üáß', 'Chin up! Next one! ‚òï'];

    function showCelebration(isMega) {
      const msgs = isMega ? CHEERS_MEGA : CHEERS;
      const msg = msgs[Math.floor(Math.random() * msgs.length)];
      const el = document.createElement('div');
      el.className = isMega ? 'mega-celebration-text' : 'celebration-text';
      el.textContent = msg;
      document.body.appendChild(el);
      const duration = isMega ? 2500 : 1800;
      setTimeout(() => el.remove(), duration);
    }

    // ===== State =====
    const state = {
      collection: "British Summer School",
      lesson: "Lesson 1",
      showHint: false,
      streak: 0,
      lessonStats: load(LS_KEY_LESSON, {}),
      itemAttempts: load(LS_KEY_ITEMS, {}),
    };

    function problemId(lesson, item) { return `${state.collection}::${lesson}::${item.term}::${item.sentence}`; }

    // ===== Init =====
    function init() {
      const colSel = $('#collection');
      const lesSel = $('#lesson');

      // Populate Collections
      const collections = Object.keys(window.WORD_DATA || {});
      if (collections.length === 0) return; // No data

      // Set default if not in state or invalid
      if (!state.collection || !window.WORD_DATA[state.collection]) {
        state.collection = collections[0];
      }

      collections.forEach(k => {
        const o = document.createElement('option');
        o.value = k; o.textContent = k;
        colSel.appendChild(o);
      });
      colSel.value = state.collection;

      // Function to update Lesson dropdown
      function updateLessonOptions() {
        lesSel.innerHTML = '';
        const lessons = window.WORD_DATA[state.collection];
        const lessonKeys = Object.keys(lessons);

        // Reset lesson if not in new collection
        if (!lessons[state.lesson]) {
          state.lesson = lessonKeys[0];
        }

        lessonKeys.forEach(k => {
          const o = document.createElement('option');
          o.value = k; o.textContent = k;
          lesSel.appendChild(o);
        });
        lesSel.value = state.lesson;
      }

      // Initial population of lessons
      updateLessonOptions();

      // Events
      colSel.addEventListener('change', () => {
        state.collection = colSel.value;
        updateLessonOptions();
        renderList();
        renderHeader();
      });

      lesSel.addEventListener('change', () => {
        state.lesson = lesSel.value;
        renderList();
        renderHeader();
      });

      $('#btn-hint').addEventListener('click', () => { state.showHint = !state.showHint; renderList(); renderHeader(); });
      $('#btn-reset').addEventListener('click', () => {
        if (!state.lessonStats[state.collection]) state.lessonStats[state.collection] = {};
        state.lessonStats[state.collection][state.lesson] = { total: 0, correct: 0 };
        save(LS_KEY_LESSON, state.lessonStats);
        renderHeader();
      });

      renderList();
      renderHeader();
    }

    function renderHeader() {
      $('#stats').textContent = `${state.collection} / ${state.lesson}ÔΩúÊ≠£Á≠îÁéá ${lessonProgressRate()}`;
      $('#btn-hint').textContent = state.showHint ? 'üí° Hint ON' : 'üí° Hint OFF';

      const badge = $('#streak-badge');
      const countEl = $('#streak-count');
      if (state.streak >= 2) {
        badge.style.display = 'inline-flex';
        countEl.textContent = state.streak;
        badge.classList.toggle('mega', state.streak >= 5);
      } else {
        badge.style.display = 'none';
      }
    }

    function lessonProgressRate() {
      if (!state.lessonStats[state.collection]) return '‚Äî';
      const rec = state.lessonStats[state.collection][state.lesson];
      if (!rec || rec.total === 0) return '‚Äî';
      return `${Math.round(rec.correct / rec.total * 100)}% (${rec.correct}/${rec.total})`;
    }

    function itemStatsText(lesson, item) {
      const id = problemId(lesson, item);
      const arr = state.itemAttempts[id] || [];
      if (arr.length === 0) return '„Åì„ÅÆÂïèÈ°å„ÅÆÂ±•Ê≠¥Ôºö‚Äî';
      const total = arr.length;
      const correct = arr.filter(a => a.correct).length;
      const rate = Math.round(correct / total * 100);
      const last = arr[arr.length - 1].date;
      const since = new Date(); since.setDate(since.getDate() - 6);
      const cutoff = since.toISOString().slice(0, 10);
      const w7 = arr.filter(a => a.date >= cutoff);
      const w7Total = w7.length;
      const w7Correct = w7.filter(a => a.correct).length;
      const w7Rate = w7Total ? Math.round(w7Correct / w7Total * 100) : '‚Äî';
      return `Ê≠£Á≠îÁéáÔºö${rate}% (${correct}/${total})ÔΩúÁõ¥Ëøë7Êó•Ôºö${w7Rate}${w7Total ? `% (${w7Correct}/${w7Total})` : ''}ÔΩúÊúÄÁµÇÔºö${last}`;
    }

    function renderList() {
      const container = $('#list');
      container.innerHTML = '';
      const currentLessons = window.WORD_DATA[state.collection] || {};
      const items = currentLessons[state.lesson] || [];

      items.forEach((it, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'item';
        wrap.id = `item-${idx}`;

        const head = document.createElement('div');
        head.className = 'item-head';
        head.innerHTML = `<div class="idx">${idx + 1}</div>`;

        const cloze = document.createElement('div');
        cloze.className = 'cloze';
        cloze.textContent = makeCloze(it.sentence, it.term).text;

        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.style.display = state.showHint ? '' : 'none';
        hint.textContent = `üí¨ „Éí„É≥„ÉàÔºö${it.jp}`;

        const controls = document.createElement('div');
        controls.className = 'controls';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Type your answer here‚Ä¶';
        input.id = `ans-${idx}`;

        const btnCheck = document.createElement('button');
        btnCheck.className = 'btn-primary';
        btnCheck.textContent = '‚úÖ Check!';
        btnCheck.addEventListener('click', () => check(idx));

        const btnReveal = document.createElement('button');
        btnReveal.textContent = 'üëÅ Answer';
        btnReveal.addEventListener('click', () => { input.value = it.term; setJudge(idx, true, false); renderHeader(); });

        controls.append(input, btnCheck, btnReveal);

        const judge = document.createElement('div');
        judge.className = 'judge';
        judge.id = `judge-${idx}`;

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.id = `meta-${idx}`;
        meta.textContent = itemStatsText(state.lesson, it);

        wrap.append(head, cloze, hint, controls, judge, meta);
        container.appendChild(wrap);

        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') check(idx); });
      });
    }

    function setJudge(idx, isCorrect, record = true) {
      const judge = document.getElementById(`judge-${idx}`);
      const itemEl = document.getElementById(`item-${idx}`);
      judge.className = 'judge';
      itemEl.classList.remove('correct-flash', 'wrong-shake');

      if (isCorrect) {
        judge.textContent = CHEERS[Math.floor(Math.random() * CHEERS.length)].replace(/[^\w\s!.]/g, '') + ' Ê≠£Ëß£ÔºÅ';
        judge.classList.add('ok');
        // Trigger card animation
        void itemEl.offsetWidth; // force reflow
        itemEl.classList.add('correct-flash');
      } else {
        const currentLessons = window.WORD_DATA[state.collection] || {};
        const it = (currentLessons[state.lesson] || [])[idx];
        const missMsg = MISS_MSGS[Math.floor(Math.random() * MISS_MSGS.length)];
        judge.innerHTML = `${missMsg}<br>Ê≠£Ëß£„ÅØ: <strong>${it.term}</strong>`;
        judge.classList.add('bad');
        void itemEl.offsetWidth;
        itemEl.classList.add('wrong-shake');
      }

      if (!record) return;

      // Streak & celebrations
      if (isCorrect) {
        state.streak++;
        const isMega = state.streak >= 5 && state.streak % 5 === 0;
        playFanfare(isMega);
        launchConfetti(isMega);
        showCelebration(isMega);
      } else {
        state.streak = 0;
        playWrongSound();
      }

      // Lesson stats
      if (!state.lessonStats[state.collection]) state.lessonStats[state.collection] = {};
      const rec = state.lessonStats[state.collection][state.lesson] || { total: 0, correct: 0 };
      rec.total += 1; rec.correct += isCorrect ? 1 : 0;
      state.lessonStats[state.collection][state.lesson] = rec;
      save(LS_KEY_LESSON, state.lessonStats);

      // Item history
      const currentLessons = window.WORD_DATA[state.collection] || {};
      const item = (currentLessons[state.lesson] || [])[idx];
      const id = problemId(state.lesson, item);
      const arr = state.itemAttempts[id] || [];
      arr.push({ date: todayISO(), correct: isCorrect });
      state.itemAttempts[id] = arr; save(LS_KEY_ITEMS, state.itemAttempts);

      // Update meta
      const meta = document.getElementById(`meta-${idx}`);
      meta.textContent = itemStatsText(state.lesson, item);
    }

    function check(idx) {
      const input = document.getElementById(`ans-${idx}`);
      if (input.dataset.locked === "true") return;
      input.dataset.locked = "true";
      const currentLessons = window.WORD_DATA[state.collection] || {};
      const it = (currentLessons[state.lesson] || [])[idx];
      const ans = normalize(input.value);
      const ok = buildAcceptableAnswers(it.term).includes(ans);
      setJudge(idx, ok, true);
      renderHeader();
      input.addEventListener('input', () => { input.dataset.locked = "false"; }, { once: true });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>