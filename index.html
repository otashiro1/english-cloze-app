<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>英単語クロース練習アプリ（Lesson 1–6｜一覧＆履歴）</title>
<style>
  :root { --bg:#f7f9fc; --panel:#ffffff; --muted:#6b7280; --text:#0f172a; --accent:#2563eb; --ok:#059669; --bad:#dc2626; --ring:#e5e7eb; }
  html, body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; color:var(--text); background: linear-gradient(#fff, var(--bg)); }
  .container { max-width: 980px; margin: 0 auto; padding: 24px; }
  header { display:flex; align-items:center; justify-content:space-between; gap: 16px; margin-bottom:16px; }
  h1 { font-size: 22px; margin: 0; }
  .stats { color: var(--muted); font-size: 13px; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .card { background: var(--panel); border: 1px solid var(--ring); border-radius: 16px; box-shadow: 0 6px 16px rgba(15,23,42,.06); padding: 16px; }
  .list { display:grid; grid-template-columns: 1fr; gap: 12px; }
  .item { border:1px solid var(--ring); border-radius: 14px; padding: 14px; background:#fff; }
  .item-head { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .idx { font-size: 12px; color: var(--muted); }
  .cloze { font-size: clamp(18px, 2.6vw, 24px); font-weight: 600; background: #f3f4f6; border-radius: 12px; padding: 10px 12px; line-height: 1.5; }
  .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
  .controls { display:flex; gap:8px; align-items:center; margin-top: 8px; flex-wrap:wrap; }
  input[type="text"] { border: 1px solid var(--ring); border-radius: 10px; padding: 8px 10px; font-size: 16px; min-width: 260px; flex: 1 1 260px; }
  button { border: 1px solid var(--ring); background: #fff; border-radius: 10px; padding: 8px 10px; font-size: 14px; cursor: pointer; transition: .15s ease; }
  button:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,.06); }
  .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-danger { border-color: #fca5a5; background: #fff5f5; }
  .judge { min-height: 20px; font-size: 14px; font-weight: 600; margin-top: 2px; }
  .ok { color: var(--ok); }
  .bad { color: var(--bad); }
  .meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .footer { margin-top: 16px; text-align:center; font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>英単語クロース練習アプリ</h1>
      <div id="stats" class="stats">読み込み中…</div>
    </header>

    <div class="card" style="margin-bottom:14px;">
      <div class="toolbar">
        <label for="lesson">レッスン</label>
        <select id="lesson"></select>
        <button id="btn-hint" title="日本語ヒントのON/OFF">和訳ヒント OFF</button>
        <button id="btn-reset" class="btn-danger" title="このレッスンの成績をリセット">成績リセット</button>
      </div>
      <div style="color:var(--muted); font-size:12px; margin-top:6px;">※ 複数語の解答は、語数ぶん <strong>____</strong> が並びます（例：<em>in a flash</em> → <strong>____ ____ ____</strong>）。入力欄は語句全体を半角スペースで入力してください。</div>
    </div>

    <div id="list" class="list"></div>

    <div class="footer">データ編集はHTML末尾の <code>LESSONS</code> を更新してください。UTF-8で保存し、ブラウザで開けば動きます。</div>
  </div>

<script>
// ===== Data (Lesson 1–6) =====
const LESSONS = {
  "Lesson 1": [
    {
      "term": "adventure",
      "sentence": "have had quite an adventure",
      "jp": "すごい冒険をした"
    },
    {
      "term": "bowl",
      "sentence": "handed Sparky's bowl",
      "jp": "Sparkyのボウル（鉢）を渡した"
    },
    {
      "term": "bring [brought]",
      "sentence": "brought me to the door",
      "jp": "私をドアの前まで連れてきた"
    },
    {
      "term": "captain",
      "sentence": "a picture of me and the captain",
      "jp": "私と船長の写真"
    },
    {
      "term": "clap",
      "sentence": "clapped his hand to his forehead",
      "jp": "彼の額で手をポンと叩いた"
    },
    {
      "term": "crew",
      "sentence": "with the crew",
      "jp": "乗組員と一緒に"
    },
    {
      "term": "cross",
      "sentence": "crossed Lake Erie",
      "jp": "エリー湖を渡った"
    },
    {
      "term": "forehead",
      "sentence": "clapped his hand to his forehead",
      "jp": "彼の額で手をポンと叩いた"
    },
    {
      "term": "goldfish",
      "sentence": "remembered his goldfish",
      "jp": "彼の金魚を思い出した"
    },
    {
      "term": "mover",
      "sentence": "head mover",
      "jp": "引っ越し業者のリーダー"
    },
    {
      "term": "plenty",
      "sentence": "plenty of room",
      "jp": "十分な空間"
    },
    {
      "term": "quite",
      "sentence": "have had quite an adventure",
      "jp": "すごい冒険をした"
    },
    {
      "term": "remember",
      "sentence": "remembered his goldfish",
      "jp": "彼の金魚を思い出した"
    },
    {
      "term": "sail",
      "sentence": "sailed on a small cargo ship",
      "jp": "小さな貨物船に乗って航海した"
    },
    {
      "term": "stare",
      "sentence": "stared at each other",
      "jp": "互いをじっと見つめ合った"
    }
  ],
  "Lesson 2": [
    {
      "term": "energy",
      "sentence": "make energy",
      "jp": "エネルギーを作り出す"
    },
    {
      "term": "fill",
      "sentence": "be filled with water",
      "jp": "水で満たす"
    },
    {
      "term": "firm",
      "sentence": "stay firm and upright",
      "jp": "硬く直立した状態を保つ"
    },
    {
      "term": "flexible",
      "sentence": "strong and flexible",
      "jp": "丈夫で柔軟な"
    },
    {
      "term": "internal",
      "sentence": "internal tubes",
      "jp": "内部の管"
    },
    {
      "term": "lack",
      "sentence": "die from a lack of energy",
      "jp": "エネルギー不足で死ぬ"
    },
    {
      "term": "muscle",
      "sentence": "human muscles",
      "jp": "人間の筋肉"
    },
    {
      "term": "shape",
      "sentence": "keep their shape",
      "jp": "彼らの形を保つ"
    },
    {
      "term": "store",
      "sentence": "store water",
      "jp": "水を蓄える、水を貯める"
    },
    {
      "term": "strong",
      "sentence": "strong and flexible",
      "jp": "強く柔軟な"
    },
    {
      "term": "sugar",
      "sentence": "use this sugar for energy",
      "jp": "この糖分をエネルギーとして使用する"
    },
    {
      "term": "tissue",
      "sentence": "plant tissue",
      "jp": "植物組織"
    },
    {
      "term": "tube",
      "sentence": "internal tubes",
      "jp": "内部の管"
    },
    {
      "term": "upright",
      "sentence": "stay firm and upright",
      "jp": "硬く直立した状態を保つ"
    },
    {
      "term": "use",
      "sentence": "use water",
      "jp": "水を使用する"
    }
  ],
  "Lesson 3": [
    {
      "term": "break down",
      "sentence": "break down most foods",
      "jp": "ほとんどの食べ物を分解する"
    },
    {
      "term": "flow",
      "sentence": "keeps our blood flowing",
      "jp": "私たちの血が流れ続ける"
    },
    {
      "term": "function",
      "sentence": "three basic important functions",
      "jp": "基本的な3つの重要な機能"
    },
    {
      "term": "glue",
      "sentence": "acts like glue",
      "jp": "接着剤のような役割をする"
    },
    {
      "term": "keep",
      "sentence": "keeps our blood flowing",
      "jp": "私たちの血が流れ続ける"
    },
    {
      "term": "necessary",
      "sentence": "necessary",
      "jp": "必要な"
    },
    {
      "term": "nutrient",
      "sentence": "get important nutrients",
      "jp": "重要な栄養素を得る"
    },
    {
      "term": "organ",
      "sentence": "our muscles and organs",
      "jp": "私たちの筋肉と臓器"
    },
    {
      "term": "properly",
      "sentence": "flow properly",
      "jp": "ちゃんと流れる"
    },
    {
      "term": "separate",
      "sentence": "separate the nutrients from the waste",
      "jp": "栄養素を廃棄物から分離する"
    },
    {
      "term": "skin",
      "sentence": "keeps our skin strong",
      "jp": "私たちの皮膚を丈夫に保つ"
    },
    {
      "term": "survive",
      "sentence": "needs water to survive",
      "jp": "生存するためには水が必要だ"
    },
    {
      "term": "thick",
      "sentence": "too thick to flow",
      "jp": "流れるにはどろどろすぎる"
    },
    {
      "term": "tiny",
      "sentence": "tiny veins",
      "jp": "とても小さな静脈"
    },
    {
      "term": "waste",
      "sentence": "separate the nutrients from the waste",
      "jp": "栄養素を廃棄物から分離する"
    }
  ],
  "Lesson 4": [
    {
      "term": "appliance",
      "sentence": "all the appliances",
      "jp": "すべての家電製品"
    },
    {
      "term": "cooking",
      "sentence": "Grandma's irreplaceable cooking",
      "jp": "おばあさんのかけがえのない料理"
    },
    {
      "term": "figure out",
      "sentence": "figure out the rest",
      "jp": "その残りは理解しました"
    },
    {
      "term": "float",
      "sentence": "floating in it",
      "jp": "その中で浮かんでいる"
    },
    {
      "term": "gadget",
      "sentence": "many gadgets",
      "jp": "たくさんの道具"
    },
    {
      "term": "glow",
      "sentence": "glowed orange",
      "jp": "オレンジ色に輝いた"
    },
    {
      "term": "irreplaceable",
      "sentence": "Grandma's irreplaceable cooking",
      "jp": "おばあさんのかけがえのない料理"
    },
    {
      "term": "odorless",
      "sentence": "The gel is odorless.",
      "jp": "そのゲルは無臭です"
    },
    {
      "term": "panel",
      "sentence": "a panel slid open",
      "jp": "1つの板が滑るように開いた"
    },
    {
      "term": "pull out",
      "sentence": "pulled out a sausage",
      "jp": "ソーセージを1つ取り出した"
    },
    {
      "term": "reveal",
      "sentence": "revealing hanging pots and pans",
      "jp": "壁にかけられたポットと鍋が姿を現しながら"
    },
    {
      "term": "shelf [shelves]",
      "sentence": "on a shelf",
      "jp": "棚の上に"
    },
    {
      "term": "slide [slid]",
      "sentence": "a panel slid open",
      "jp": "1つの板が滑るように開いた"
    },
    {
      "term": "stay away",
      "sentence": "stay away from this kitchen",
      "jp": "この台所から離れていなさい"
    },
    {
      "term": "straight",
      "sentence": "went straight",
      "jp": "まっすぐ行った"
    }
  ],
  "Lesson 5": [
    {
      "term": "allow",
      "sentence": "allow computers to become even smaller",
      "jp": "コンピューターをより一層小さくしてくれる"
    },
    {
      "term": "connection",
      "sentence": "What's the connection?",
      "jp": "どんな関連性があるのでしょう？"
    },
    {
      "term": "create",
      "sentence": "create the solutions",
      "jp": "解決策を生み出す"
    },
    {
      "term": "deal with",
      "sentence": "deals with saving energy",
      "jp": "エネルギーの節約を扱う"
    },
    {
      "term": "device",
      "sentence": "energy storage devices",
      "jp": "エネルギーを保存する装置"
    },
    {
      "term": "electricity",
      "sentence": "store electricity",
      "jp": "電気を保存する"
    },
    {
      "term": "frame",
      "sentence": "in the frames",
      "jp": "メガネフレームの中に"
    },
    {
      "term": "inexpensive",
      "sentence": "inexpensive insulation",
      "jp": "安い断熱材"
    },
    {
      "term": "insulation",
      "sentence": "inexpensive insulation",
      "jp": "安い断熱材"
    },
    {
      "term": "man-made",
      "sentence": "man-made nano-materials",
      "jp": "人が作り出したナノ物質"
    },
    {
      "term": "pass through",
      "sentence": "keeping air from passing through",
      "jp": "空気が通過するのを防ぐ"
    },
    {
      "term": "promising",
      "sentence": "promising nanotechnology research",
      "jp": "有望なナノテクノロジーの研究"
    },
    {
      "term": "save",
      "sentence": "saves energy and money",
      "jp": "エネルギーとお金を節約する"
    },
    {
      "term": "storage",
      "sentence": "energy storage",
      "jp": "エネルギーを保存する"
    },
    {
      "term": "temperature",
      "sentence": "maintain temperatures",
      "jp": "温度を維持する"
    }
  ],
  "Lesson 6": [
    {
      "term": "advanced",
      "sentence": "the most advanced shoe",
      "jp": "最も進歩した靴"
    },
    {
      "term": "arch",
      "sentence": "arch",
      "jp": "土踏まず"
    },
    {
      "term": "brand new",
      "sentence": "some brand new shoes",
      "jp": "いくつかの真新しい靴"
    },
    {
      "term": "combine",
      "sentence": "combines the natural feel with added protection",
      "jp": "自然な感覚と保護する機能を兼ね備えている"
    },
    {
      "term": "extra",
      "sentence": "at no extra charge",
      "jp": "追加料金なし"
    },
    {
      "term": "fit ... like a glove",
      "sentence": "fits your foot like a glove",
      "jp": "あつらえたよう（手袋のように）にあなたの足にぴったり合う"
    },
    {
      "term": "last",
      "sentence": "lasts for one week",
      "jp": "1週間続けられる"
    },
    {
      "term": "material",
      "sentence": "mesh material",
      "jp": "メッシュ素材"
    },
    {
      "term": "metal",
      "sentence": "metal springs",
      "jp": "金属スプリング"
    },
    {
      "term": "protection",
      "sentence": "protection from scrapes and cuts",
      "jp": "すり傷と切り傷から保護"
    },
    {
      "term": "run out",
      "sentence": "until supplies run out",
      "jp": "供給品が品切れになるまで"
    },
    {
      "term": "sale",
      "sentence": "sale",
      "jp": "割引販売、バーゲン"
    },
    {
      "term": "shock",
      "sentence": "shock absorption",
      "jp": "衝撃吸収"
    },
    {
      "term": "supply",
      "sentence": "until supplies run out",
      "jp": "供給品が品切れになるまで"
    },
    {
      "term": "vest",
      "sentence": "bulletproof vests",
      "jp": "防弾チョッキ"
    }
  ]

};

// ===== Utilities =====
const $ = (sel) => document.querySelector(sel);
const LS_KEY_LESSON = 'cloze-app-lesson-stats-v2'; // レッスン集計
const LS_KEY_ITEMS  = 'cloze-app-item-attempts-v2'; // 問題ごとの実施履歴
function normalize(s){return s.toLowerCase().replace(/\s+/g,' ').trim();}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');}
function todayISO(){ const d = new Date(); const tz = new Date(d.getTime()-d.getTimezoneOffset()*60000); return tz.toISOString().slice(0,10); }
function countWords(phrase){ return normalize(phrase).split(' ').length; }
function blanksFor(phrase){ return Array.from({length: countWords(phrase)}, ()=>'____').join(' '); }

function buildAcceptableAnswers(base){
  const b = normalize(base);
  if (b.includes(' ')){
    const parts = b.split(' ');
    const last = parts[parts.length-1];
    const set = new Set([b]);
    const sForm = last.endsWith('s') ? last : last + 's';
    set.add([...parts.slice(0,-1), sForm].join(' '));
    return [...set];
  }
  const set = new Set([b]);
  if (!b.endsWith('s')) set.add(b+'s');
  if (!b.endsWith('es')) set.add(b+'es');
  if (!b.endsWith('ed')) set.add(b+'ed');
  if (!b.endsWith('ing')) set.add(b+'ing');
  return [...set];
}

function makeCloze(sentence, base){
  const variants = buildAcceptableAnswers(base).sort((a,b)=>b.length-a.length);
  const multi = countWords(base) > 1;
  const replacement = multi ? blanksFor(base) : '____';
  let out = sentence, replaced=false;
  for (const v of variants){
    const re = new RegExp(`\\b${escapeRegExp(v)}\\b`, 'i');
    if (re.test(out)) { out = out.replace(re, replacement); replaced=true; break; }
  }
  if (!replaced) out = `${sentence} (${replacement})`;
  return { text: out, replaced };
}

function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback)); }catch{ return fallback; } }
function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

// ===== State =====
const state = {
  lesson: Object.keys(LESSONS)[0],
  showHint: false,
  lessonStats: load(LS_KEY_LESSON, {}),
  itemAttempts: load(LS_KEY_ITEMS, {}), // { problemId: [{date, correct}] }
};

function problemId(lesson, item){ return `${lesson}::${item.term}::${item.sentence}`; }

// ===== Init =====
function init(){
  const sel = $('#lesson');
  Object.keys(LESSONS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
  sel.value = state.lesson;

  sel.addEventListener('change', ()=>{ state.lesson = sel.value; renderList(); renderHeader(); });
  $('#btn-hint').addEventListener('click', ()=>{ state.showHint=!state.showHint; renderList(); renderHeader(); });
  $('#btn-reset').addEventListener('click', ()=>{ state.lessonStats[state.lesson] = { total:0, correct:0 }; save(LS_KEY_LESSON, state.lessonStats); renderHeader(); });

  renderList();
  renderHeader();
}

function renderHeader(){
  $('#stats').textContent = `${state.lesson}｜正答率 ${lessonProgressRate()}`;
  $('#btn-hint').textContent = state.showHint ? '和訳ヒント ON' : '和訳ヒント OFF';
}

function lessonProgressRate(){
  const rec = state.lessonStats[state.lesson];
  if (!rec || rec.total===0) return '—';
  return `${Math.round(rec.correct/rec.total*100)}% (${rec.correct}/${rec.total})`;
}

function itemStatsText(lesson, item){
  const id = problemId(lesson, item);
  const arr = state.itemAttempts[id] || [];
  if (arr.length === 0) return 'この問題の履歴：—';
  const total = arr.length;
  const correct = arr.filter(a=>a.correct).length;
  const rate = Math.round(correct/total*100);
  const last = arr[arr.length-1].date;
  const since = new Date(); since.setDate(since.getDate()-6);
  const cutoff = since.toISOString().slice(0,10);
  const w7 = arr.filter(a=> a.date >= cutoff);
  const w7Total = w7.length;
  const w7Correct = w7.filter(a=>a.correct).length;
  const w7Rate = w7Total ? Math.round(w7Correct/w7Total*100) : '—';
  return `この問題の正答率：${rate}% (${correct}/${total})｜直近7日：${w7Rate}${w7Total?`% (${w7Correct}/${w7Total})`:''}｜最終実施日：${last}`;
}

function renderList(){
  const container = $('#list');
  container.innerHTML = '';
  const items = LESSONS[state.lesson];

  items.forEach((it, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'item';

    const head = document.createElement('div');
    head.className = 'item-head';
    head.innerHTML = `<div class="idx">#${idx+1}</div>`;

    const cloze = document.createElement('div');
    cloze.className = 'cloze';
    cloze.textContent = makeCloze(it.sentence, it.term).text;

    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.style.display = state.showHint ? '' : 'none';
    hint.textContent = `ヒント（日）：${it.jp}`;

    const controls = document.createElement('div');
    controls.className = 'controls';
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = '解答（例: in a flash）';
    input.id = `ans-${idx}`;

    const btnCheck = document.createElement('button');
    btnCheck.className = 'btn-primary';
    btnCheck.textContent = '判定';
    btnCheck.addEventListener('click', ()=>check(idx));

    const btnReveal = document.createElement('button');
    btnReveal.textContent = '答えを表示';
    btnReveal.addEventListener('click', ()=>{ input.value = it.term; setJudge(idx, true, false); renderHeader(); });

    controls.append(input, btnCheck, btnReveal);

    const judge = document.createElement('div');
    judge.className = 'judge';
    judge.id = `judge-${idx}`;

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.id = `meta-${idx}`;
    meta.textContent = itemStatsText(state.lesson, it);

    wrap.append(head, cloze, hint, controls, judge, meta);
    container.appendChild(wrap);

    input.addEventListener('keydown', (e)=>{ if (e.key==='Enter') check(idx); });
  });
}

function setJudge(idx, isCorrect, record=true){
  const judge = document.getElementById(`judge-${idx}`);
  judge.className = 'judge';
  if (isCorrect){ judge.textContent = '正解！よくできました。'; judge.classList.add('ok'); }
  else { judge.textContent = `不正解…`; judge.classList.add('bad'); }

  if (!record) return; // 答え表示時は記録しない

  // 集計（レッスン）
  const rec = state.lessonStats[state.lesson] || { total:0, correct:0 };
  rec.total += 1; rec.correct += isCorrect ? 1 : 0; state.lessonStats[state.lesson] = rec; save(LS_KEY_LESSON, state.lessonStats);

  // 履歴（問題）
  const item = LESSONS[state.lesson][idx];
  const id = problemId(state.lesson, item);
  const arr = state.itemAttempts[id] || [];
  arr.push({ date: todayISO(), correct: isCorrect });
  state.itemAttempts[id] = arr; save(LS_KEY_ITEMS, state.itemAttempts);

  // メタ更新
  const meta = document.getElementById(`meta-${idx}`);
  meta.textContent = itemStatsText(state.lesson, item);
}

function check(idx){
  const input = document.getElementById(`ans-${idx}`);
  if (input.dataset.locked === "true") return; // ← 追加：連打防止
  input.dataset.locked = "true"; // ← 追加：この入力をロック
  const it = LESSONS[state.lesson][idx];
  const ans = normalize(input.value);
  const ok = buildAcceptableAnswers(it.term).includes(ans);
  setJudge(idx, ok, true);
  renderHeader();
  // 入力が変更されたらロック解除
  input.addEventListener('input', () => { input.dataset.locked = "false"; }, { once: true });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
